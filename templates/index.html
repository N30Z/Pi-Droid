<!doctype html>
<html>
  <head>
    <title>Pi-Droid Control</title>
    <style>
      body { font-family: Arial, sans-serif; margin: 0; }
      .container { display:flex; height: 100vh; }
      .left { width: 320px; padding: 16px; box-sizing: border-box; background:#eee; }
      .right { flex:1; display:flex; align-items:center; justify-content:center; position:relative; }
      button { display:block; width:100%; margin:8px 0; padding:12px; font-size:16px; }
      .progress { position: absolute; bottom:0; left:0; right:0; background:#ddd; padding:8px; }
      .bar { width:100%; background:#ccc; height:28px; position:relative; }
      .bar-inner { background:#4caf50; height:100%; width:30%; display:flex; align-items:center; justify-content:center; color:white; }
      .notice { background:#fff3cd; color:#664d03; border:1px solid #ffecb5; padding:10px; border-radius:6px; margin-top:10px; display:none; }
      .notice a { color:#664d03; text-decoration: underline; }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="left">
        <button onclick="startWithCount()">Start</button>
        <hr>
        <label><b>Region count:</b></label>
        <select id="regionCount" style="width:100%;padding:6px;font-size:16px;">
        <option value="4">4</option>
        <option value="5">5</option>
        <option value="6">6</option>
        <button onclick="api('/api/stop')">Stop</button>
        <button onclick="api('/api/pause')">Pause</button>
        <button onclick="api('/api/resume')">Resume</button>
        <hr>
        <button onclick="window.open('/calibrate','_blank')">Run camera calibration</button>
        </select>
        <div id="goal" style="margin-top:16px;color:darkred;font-weight:bold;"></div>
        <hr>
        <label><b>Send number:</b></label>
        <input id="numberInput" type="number" style="width:100%;padding:6px;font-size:16px;">
        <button onclick="sendNumber()" style="margin-top:6px;">Send</button>
      </div>
      <div class="right">
        <img id="video" src="/video_feed" style="max-width:100%; max-height:100%;"/>
      </div>
    </div>
    <div class="progress">
      <div>Digits: <span id="digits">0</span> &nbsp; Line: <span id="line">0</span>/<span id="lines">0</span></div>
      <div class="bar"><div class="bar-inner" id="barinner">0%</div></div>
    </div>

    <script>
        function sendNumber(){
            const val = document.getElementById('numberInput').value;
            if(!val){ alert("Enter a number."); return; }

            fetch('/api/send_number', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({value: val})
            })
            .then(r=>r.json())
            .then(j=>console.log("Sent:", j));
        }

        function startWithCount(){
            const count = document.getElementById('regionCount').value;
            fetch('/api/start?count='+count)
            .then(r=>r.json())
            .then(d=>updateStatus(d));
        }

        function api(path){ fetch(path).then(r=>r.json()).then(d=>updateStatus(d)) }
        function updateStatus(d){
            document.getElementById('digits').textContent = d.current_digits || 0;
            document.getElementById('line').textContent = d.line_progress || 0;
            document.getElementById('lines').textContent = d.num_lines || 0;
            var pct = d.num_lines ? Math.round((d.line_progress/d.num_lines)*100) : 0;
            document.getElementById('barinner').style.width = pct + '%';
            document.getElementById('barinner').textContent = pct + '%';
            if(d.goal_msg){ document.getElementById('goal').textContent = d.goal_msg }
        }
        setInterval(function(){ fetch('/api/status').then(r=>r.json()).then(updateStatus) }, 1000);
        
        setInterval(checkRegions, 500);
    </script>
  </body>
</html>
